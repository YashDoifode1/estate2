{% extends 'base.html' %}

{% block title %}Account Settings | DreamHomes Realty{% endblock %}

{% block content %}
    <!-- Settings Header -->
    <section class="settings-header bg-blue-900 text-white py-12">
        <div class="container mx-auto px-4">
            <div class="max-w-6xl mx-auto">
                <!-- Breadcrumb -->
                <nav class="flex mb-6" aria-label="Breadcrumb">
                    <ol class="flex items-center space-x-2 text-sm">
                        <li>
                            <a href="{% url 'home' %}" class="text-blue-200 hover:text-white transition">Home</a>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-chevron-right text-blue-300 mx-2"></i>
                            <a href="{% url 'profile' %}" class="text-blue-200 hover:text-white transition">My Profile</a>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-chevron-right text-blue-300 mx-2"></i>
                            <span class="text-white font-medium">Settings</span>
                        </li>
                    </ol>
                </nav>
                
                <h1 class="text-3xl md:text-4xl font-bold mb-4" data-aos="fade-up">Account Settings</h1>
                <p class="text-xl text-blue-100 max-w-2xl" data-aos="fade-up" data-aos-delay="100">
                    Manage your account preferences, security settings, and notification preferences.
                </p>
            </div>
        </div>
    </section>

    <!-- Settings Content -->
    <section class="py-8 bg-gray-50">
        <div class="container mx-auto px-4">
            <div class="max-w-6xl mx-auto">
                <div class="flex flex-col lg:flex-row gap-8">
                    <!-- Settings Navigation -->
                    <aside class="lg:w-1/4">
                        <div class="bg-white rounded-lg shadow-md p-6 sticky top-6">
                            <h2 class="text-xl font-bold text-blue-900 mb-4">Settings</h2>
                            <nav class="space-y-2">
                                <button class="nav-item w-full text-left active" data-section="profile">
                                    <i class="fas fa-user-circle mr-3 text-lg"></i>
                                    <span>Profile Information</span>
                                </button>
                                <button class="nav-item w-full text-left" data-section="security">
                                    <i class="fas fa-shield-alt mr-3 text-lg"></i>
                                    <span>Security & Password</span>
                                </button>
                                <button class="nav-item w-full text-left" data-section="preferences">
                                    <i class="fas fa-sliders-h mr-3 text-lg"></i>
                                    <span>Preferences</span>
                                </button>
                                <button class="nav-item w-full text-left" data-section="notifications">
                                    <i class="fas fa-bell mr-3 text-lg"></i>
                                    <span>Notifications</span>
                                </button>
                                <button class="nav-item w-full text-left" data-section="privacy">
                                    <i class="fas fa-lock mr-3 text-lg"></i>
                                    <span>Privacy & Data</span>
                                </button>
                                <button class="nav-item w-full text-left text-red-600 hover:bg-red-50" data-section="delete">
                                    <i class="fas fa-exclamation-triangle mr-3 text-lg"></i>
                                    <span>Delete Account</span>
                                </button>
                            </nav>
                        </div>
                    </aside>
                    
                    <!-- Settings Sections -->
                    <main class="lg:w-3/4">
                        <!-- Success/Error Messages -->
                        {% if messages %}
                        <div class="mb-6 space-y-2">
                            {% for message in messages %}
                            <div class="{% if message.tags == 'success' %}bg-green-50 border border-green-200 text-green-700{% else %}bg-red-50 border border-red-200 text-red-700{% endif %} p-4 rounded-lg">
                                <div class="flex items-center">
                                    <i class="fas {% if message.tags == 'success' %}fa-check-circle{% else %}fa-exclamation-circle{% endif %} mr-3"></i>
                                    <span>{{ message }}</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        <!-- Profile Information Section -->
                        <div id="profile" class="settings-section active">
                            <div class="bg-white rounded-lg shadow-md p-6">
                                <h2 class="text-2xl font-bold text-blue-900 mb-6">Profile Information</h2>
                                
                                <form id="profile-form" method="POST" action="{% url 'update_profile' %}">
                                    {% csrf_token %}
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                        <div>
                                            <label class="block text-gray-700 font-medium mb-2">First Name</label>
                                            <input type="text" name="first_name" value="{{ request.user.first_name|default:'' }}" 
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-900 focus:border-transparent"
                                                   placeholder="Enter your first name">
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 font-medium mb-2">Last Name</label>
                                            <input type="text" name="last_name" value="{{ request.user.last_name|default:'' }}"
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-900 focus:border-transparent"
                                                   placeholder="Enter your last name">
                                        </div>
                                    </div>
                                    
                                    <div class="mb-6">
                                        <label class="block text-gray-700 font-medium mb-2">Email Address</label>
                                        <input type="email" value="{{ request.user.email }}" 
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50"
                                               disabled>
                                        <p class="text-sm text-gray-500 mt-1">Contact support to change your email address</p>
                                    </div>
                                    
                                    <div class="mb-6">
                                        <label class="block text-gray-700 font-medium mb-2">Phone Number</label>
                                        <input type="text" name="phone_number" value="{{ user.profile.phone_number|default:'' }}"
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-900 focus:border-transparent"
                                               placeholder="Enter your phone number">
                                        {% if profile_form.phone_number.errors %}
                                            <p class="text-red-600 text-sm mt-1">{{ profile_form.phone_number.errors }}</p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="mb-6">
                                        <label class="block text-gray-700 font-medium mb-2">Location</label>
                                        <input type="text" name="location" value="{{ user.profile.location|default:'' }}"
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-900 focus:border-transparent"
                                               placeholder="Enter your location">
                                        {% if profile_form.location.errors %}
                                            <p class="text-red-600 text-sm mt-1">{{ profile_form.location.errors }}</p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="mb-6">
                                        <label class="block text-gray-700 font-medium mb-2">Bio</label>
                                        <textarea name="bio" rows="4"
                                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-900 focus:border-transparent"
                                                  placeholder="Tell us about yourself">{{ user.profile.bio|default:'' }}</textarea>
                                        {% if profile_form.bio.errors %}
                                            <p class="text-red-600 text-sm mt-1">{{ profile_form.bio.errors }}</p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="flex justify-end">
                                        <button type="submit" class="bg-blue-900 hover:bg-blue-800 text-white font-bold py-3 px-6 rounded-lg transition">
                                            Save Changes
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <!-- Security & Password Section -->
                        <div id="security" class="settings-section hidden">
                            <div class="bg-white rounded-lg shadow-md p-6">
                                <h2 class="text-2xl font-bold text-blue-900 mb-6">Security & Password</h2>
                                
                                <form id="password-form" method="POST" action="{% url 'update_password' %}">
                                    {% csrf_token %}
                                    <div class="mb-6">
                                        <label class="block text-gray-700 font-medium mb-2">Current Password</label>
                                        <input type="password" name="current_password" 
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-900 focus:border-transparent"
                                               placeholder="Enter your current password" required>
                                        {% if password_form.current_password.errors %}
                                            <p class="text-red-600 text-sm mt-1">{{ password_form.current_password.errors }}</p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="mb-6">
                                        <label class="block text-gray-700 font-medium mb-2">New Password</label>
                                        <input type="password" name="new_password1" 
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-900 focus:border-transparent"
                                               placeholder="Enter new password" required>
                                        <div id="password-strength" class="h-2 mt-2 rounded hidden">
                                            <div class="h-full rounded password-strength-bar"></div>
                                        </div>
                                        <p class="text-sm text-gray-500 mt-2">Password must be at least 8 characters with uppercase, lowercase, and numbers.</p>
                                        {% if password_form.new_password1.errors %}
                                            <p class="text-red-600 text-sm mt-1">{{ password_form.new_password1.errors }}</p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="mb-6">
                                        <label class="block text-gray-700 font-medium mb-2">Confirm New Password</label>
                                        <input type="password" name="new_password2"
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-900 focus:border-transparent"
                                               placeholder="Confirm new password" required>
                                        {% if password_form.new_password2.errors %}
                                            <p class="text-red-600 text-sm mt-1">{{ password_form.new_password2.errors }}</p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="flex justify-end">
                                        <button type="submit" class="bg-blue-900 hover:bg-blue-800 text-white font-bold py-3 px-6 rounded-lg transition">
                                            Update Password
                                        </button>
                                    </div>
                                </form>
                                
                                <hr class="my-8">
                                
                                <div class="mb-6">
                                    <h3 class="text-lg font-bold text-blue-900 mb-4">Two-Factor Authentication</h3>
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="font-medium">Two-factor authentication is 
                                                <span class="text-{% if user.profile.two_factor_enabled %}green-600{% else %}red-600{% endif %}">
                                                    {% if user.profile.two_factor_enabled %}enabled{% else %}disabled{% endif %}
                                                </span>
                                            </p>
                                            <p class="text-sm text-gray-600">Add an extra layer of security to your account</p>
                                        </div>
                                        <form method="POST" action="{% url 'toggle_2fa' %}">
                                            {% csrf_token %}
                                            <button type="submit" class="bg-blue-900 hover:bg-blue-800 text-white font-bold py-2 px-4 rounded-lg transition text-sm">
                                                {% if user.profile.two_factor_enabled %}Disable 2FA{% else %}Enable 2FA{% endif %}
                                            </button>
                                        </form>
                                    </div>
                                    <p class="text-sm text-gray-500 mt-2">Two-factor authentication will be available after system updates.</p>
                                </div>
                                
                                <div class="mb-6">
                                    <h3 class="text-lg font-bold text-blue-900 mb-4">Login Sessions</h3>
                                    {% for session in sessions %}
                                        <div class="bg-gray-50 p-4 rounded-lg mb-4">
                                            <div class="flex justify-between items-center mb-2">
                                                <div class="flex items-center">
                                                    <i class="fas fa-desktop text-blue-900 mr-3"></i>
                                                    <div>
                                                        <p class="font-medium">{{ session.device }}</p>
                                                        <p class="text-sm text-gray-600">{{ session.location }} • {{ session.ip_address }}</p>
                                                    </div>
                                                </div>
                                                <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">
                                                    Active
                                                </span>
                                            </div>
                                            <p class="text-sm text-gray-600 mt-2">Last active: {{ session.last_active|timesince }} ago</p>
                                        </div>
                                    {% empty %}
                                        <p class="text-gray-600">No active sessions found.</p>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Preferences Section -->
                        <div id="preferences" class="settings-section hidden">
                            <div class="bg-white rounded-lg shadow-md p-6">
                                <h2 class="text-2xl font-bold text-blue-900 mb-6">Property Preferences</h2>
                                
                                <form id="preferences-form" method="POST" action="{% url 'update_preferences' %}">
                                    {% csrf_token %}
                                    <div class="mb-8">
                                        <h3 class="text-lg font-bold text-blue-900 mb-4">I'm Interested In</h3>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <label class="flex items-center space-x-3 p-3 border border-gray-200 rounded-lg hover:bg-blue-50 cursor-pointer">
                                                <input type="checkbox" name="interest_buying" {% if user.preferences.interest_buying %}checked{% endif %} 
                                                       class="w-4 h-4 text-blue-900 bg-gray-100 border-gray-300 rounded focus:ring-blue-900">
                                                <span class="font-medium">Buying Properties</span>
                                            </label>
                                            <label class="flex items-center space-x-3 p-3 border border-gray-200 rounded-lg hover:bg-blue-50 cursor-pointer">
                                                <input type="checkbox" name="interest_renting" {% if user.preferences.interest_renting %}checked{% endif %}
                                                       class="w-4 h-4 text-blue-900 bg-gray-100 border-gray-300 rounded focus:ring-blue-900">
                                                <span class="font-medium">Renting Properties</span>
                                            </label>
                                            <label class="flex items-center space-x-3 p-3 border border-gray-200 rounded-lg hover:bg-blue-50 cursor-pointer">
                                                <input type="checkbox" name="interest_selling" {% if user.preferences.interest_selling %}checked{% endif %}
                                                       class="w-4 h-4 text-blue-900 bg-gray-100 border-gray-300 rounded focus:ring-blue-900">
                                                <span class="font-medium">Selling Properties</span>
                                            </label>
                                            <label class="flex items-center space-x-3 p-3 border border-gray-200 rounded-lg hover:bg-blue-50 cursor-pointer">
                                                <input type="checkbox" name="interest_commercial" {% if user.preferences.interest_commercial %}checked{% endif %}
                                                       class="w-4 h-4 text-blue-900 bg-gray-100 border-gray-300 rounded focus:ring-blue-900">
                                                <span class="font-medium">Commercial Properties</span>
                                            </label>
                                        </div>
                                        {% if preferences_form.interest_buying.errors %}
                                            <p class="text-red-600 text-sm mt-1">{{ preferences_form.interest_buying.errors }}</p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="mb-8">
                                        <h3 class="text-lg font-bold text-blue-900 mb-4">Budget Range (₹)</h3>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div>
                                                <label class="block text-gray-700 font-medium mb-2">Minimum Budget</label>
                                                <input type="number" name="min_budget" value="{{ user.preferences.min_budget|default:'' }}"
                                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-900 focus:border-transparent"
                                                       placeholder="e.g., 500000">
                                                {% if preferences_form.min_budget.errors %}
                                                    <p class="text-red-600 text-sm mt-1">{{ preferences_form.min_budget.errors }}</p>
                                                {% endif %}
                                            </div>
                                            <div>
                                                <label class="block text-gray-700 font-medium mb-2">Maximum Budget</label>
                                                <input type="number" name="max_budget" value="{{ user.preferences.max_budget|default:'' }}"
                                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-900 focus:border-transparent"
                                                       placeholder="e.g., 5000000">
                                                {% if preferences_form.max_budget.errors %}
                                                    <p class="text-red-600 text-sm mt-1">{{ preferences_form.max_budget.errors }}</p>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-8">
                                        <h3 class="text-lg font-bold text-blue-900 mb-4">Preferred Locations in Nagpur</h3>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            {% with locations="Civil Lines,Ram Nagar,Dharampeth,Manish Nagar,Wardha Road,Byramji Town,Sitabuldi,Sadar,Ambazari,Hingna" %}
                                            {% for location in locations.split %}
                                            <label class="flex items-center space-x-3 p-3 border border-gray-200 rounded-lg hover:bg-blue-50 cursor-pointer">
                                                <input type="checkbox" name="preferred_locations" value="{{ location }}"
                                                       {% if location in user.preferences.preferred_locations %}checked{% endif %}
                                                       class="w-4 h-4 text-blue-900 bg-gray-100 border-gray-300 rounded focus:ring-blue-900">
                                                <span>{{ location }}</span>
                                            </label>
                                            {% endfor %}
                                            {% endwith %}
                                        </div>
                                        {% if preferences_form.preferred_locations.errors %}
                                            <p class="text-red-600 text-sm mt-1">{{ preferences_form.preferred_locations.errors }}</p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="mb-8">
                                        <h3 class="text-lg font-bold text-blue-900 mb-4">Property Types</h3>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            {% with types="Apartment,Independent House,Villa,Plot,Commercial Space,Office Space,Shop,Warehouse" %}
                                            {% for type in types.split %}
                                            <label class="flex items-center space-x-3 p-3 border border-gray-200 rounded-lg hover:bg-blue-50 cursor-pointer">
                                                <input type="checkbox" name="property_types" value="{{ type }}"
                                                       {% if type in user.preferences.property_types %}checked{% endif %}
                                                       class="w-4 h-4 text-blue-900 bg-gray-100 border-gray-300 rounded focus:ring-blue-900">
                                                <span>{{ type }}</span>
                                            </label>
                                            {% endfor %}
                                            {% endwith %}
                                        </div>
                                        {% if preferences_form.property_types.errors %}
                                            <p class="text-red-600 text-sm mt-1">{{ preferences_form.property_types.errors }}</p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="flex justify-end">
                                        <button type="submit" class="bg-blue-900 hover:bg-blue-800 text-white font-bold py-3 px-6 rounded-lg transition">
                                            Save Preferences
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <!-- Notifications Section -->
                        <div id="notifications" class="settings-section hidden">
                            <div class="bg-white rounded-lg shadow-md p-6">
                                <h2 class="text-2xl font-bold text-blue-900 mb-6">Notification Preferences</h2>
                                
                                <form id="notifications-form" method="POST" action="{% url 'update_notifications' %}">
                                    {% csrf_token %}
                                    <div class="mb-8">
                                        <h3 class="text-lg font-bold text-blue-900 mb-4">Email Notifications</h3>
                                        <div class="space-y-4">
                                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                                <div>
                                                    <p class="font-medium">Property Recommendations</p>
                                                    <p class="text-sm text-gray-600">Get notified about properties matching your preferences</p>
                                                </div>
                                                <label class="relative inline-flex items-center cursor-pointer">
                                                    <input type="checkbox" name="email_property_recommendations" {% if user.notification_settings.email_property_recommendations %}checked{% endif %} class="sr-only peer">
                                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-900"></div>
                                                </label>
                                            </div>
                                            
                                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                                <div>
                                                    <p class="font-medium">Price Drop Alerts</p>
                                                    <p class="text-sm text-gray-600">Get notified when prices drop on saved properties</p>
                                                </div>
                                                <label class="relative inline-flex items-center cursor-pointer">
                                                    <input type="checkbox" name="email_price_drop_alerts" {% if user.notification_settings.email_price_drop_alerts %}checked{% endif %} class="sr-only peer">
                                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-900"></div>
                                                </label>
                                            </div>
                                            
                                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                                <div>
                                                    <p class="font-medium">New Listings</p>
                                                    <p class="text-sm text-gray-600">Get notified about new properties in your preferred areas</p>
                                                </div>
                                                <label class="relative inline-flex items-center cursor-pointer">
                                                    <input type="checkbox" name="email_new_listings" {% if user.notification_settings.email_new_listings %}checked{% endif %} class="sr-only peer">
                                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-900"></div>
                                                </label>
                                            </div>
                                            
                                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                                <div>
                                                    <p class="font-medium">Market Updates</p>
                                                    <p class="text-sm text-gray-600">Receive real estate market insights and trends</p>
                                                </div>
                                                <label class="relative inline-flex items-center cursor-pointer">
                                                    <input type="checkbox" name="email_market_updates" {% if user.notification_settings.email_market_updates %}checked{% endif %} class="sr-only peer">
                                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-900"></div>
                                                </label>
                                            </div>
                                            
                                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                                <div>
                                                    <p class="font-medium">Promotional Offers</p>
                                                    <p class="text-sm text-gray-600">Receive special offers and discounts</p>
                                                </div>
                                                <label class="relative inline-flex items-center cursor-pointer">
                                                    <input type="checkbox" name="email_promotional_offers" {% if user.notification_settings.email_promotional_offers %}checked{% endif %} class="sr-only peer">
                                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-900"></div>
                                                </label>
                                            </div>
                                        </div>
                                        {% if notifications_form.email_property_recommendations.errors %}
                                            <p class="text-red-600 text-sm mt-1">{{ notifications_form.email_property_recommendations.errors }}</p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="mb-8">
                                        <h3 class="text-lg font-bold text-blue-900 mb-4">Push Notifications</h3>
                                        <div class="space-y-4">
                                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                                <div>
                                                    <p class="font-medium">Mobile Push Notifications</p>
                                                    <p class="text-sm text-gray-600">Receive notifications on your mobile device</p>
                                                </div>
                                                <label class="relative inline-flex items-center cursor-pointer">
                                                    <input type="checkbox" name="push_notifications" {% if user.notification_settings.push_notifications %}checked{% endif %} class="sr-only peer">
                                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-900"></div>
                                                </label>
                                            </div>
                                            
                                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                                <div>
                                                    <p class="font-medium">SMS Notifications</p>
                                                    <p class="text-sm text-gray-600">Receive important alerts via SMS</p>
                                                </div>
                                                <label class="relative inline-flex items-center cursor-pointer">
                                                    <input type="checkbox" name="sms_notifications" {% if user.notification_settings.sms_notifications %}checked{% endif %} class="sr-only peer">
                                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-900"></div>
                                                </label>
                                            </div>
                                        </div>
                                        {% if notifications_form.push_notifications.errors %}
                                            <p class="text-red-600 text-sm mt-1">{{ notifications_form.push_notifications.errors }}</p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="flex justify-end">
                                        <button type="submit" class="bg-blue-900 hover:bg-blue-800 text-white font-bold py-3 px-6 rounded-lg transition">
                                            Save Notification Settings
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <!-- Privacy & Data Section -->
                        <div id="privacy" class="settings-section hidden">
                            <div class="bg-white rounded-lg shadow-md p-6">
                                <h2 class="text-2xl font-bold text-blue-900 mb-6">Privacy & Data</h2>
                                
                                <form id="privacy-form" method="POST" action="{% url 'update_privacy' %}">
                                    {% csrf_token %}
                                    <div class="mb-8">
                                        <h3 class="text-lg font-bold text-blue-900 mb-4">Data Privacy</h3>
                                        <div class="space-y-4">
                                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                                <div>
                                                    <p class="font-medium">Data Sharing with Partners</p>
                                                    <p class="text-sm text-gray-600">Allow us to share your preferences with trusted partners for better service</p>
                                                </div>
                                                <label class="relative inline-flex items-center cursor-pointer">
                                                    <input type="checkbox" name="data_sharing" {% if user.privacy_settings.data_sharing %}checked{% endif %} class="sr-only peer">
                                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-900"></div>
                                                </label>
                                            </div>
                                            
                                            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                                <div>
                                                    <p class="font-medium">Personalized Ads</p>
                                                    <p class="text-sm text-gray-600">Show personalized property recommendations based on your activity</p>
                                                </div>
                                                <label class="relative inline-flex items-center cursor-pointer">
                                                    <input type="checkbox" name="personalized_ads" {% if user.privacy_settings.personalized_ads %}checked{% endif %} class="sr-only peer">
                                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-900"></div>
                                                </label>
                                            </div>
                                        </div>
                                        {% if privacy_form.data_sharing.errors %}
                                            <p class="text-red-600 text-sm mt-1">{{ privacy_form.data_sharing.errors }}</p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="flex justify-end">
                                        <button type="submit" class="bg-blue-900 hover:bg-blue-800 text-white font-bold py-3 px-6 rounded-lg transition">
                                            Save Privacy Settings
                                        </button>
                                    </div>
                                </form>
                                
                                <div class="mb-8">
                                    <h3 class="text-lg font-bold text-blue-900 mb-4">Data Management</h3>
                                    <div class="space-y-4">
                                        <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                            <div>
                                                <p class="font-medium">Download Your Data</p>
                                                <p class="text-sm text-gray-600">Request a copy of all your personal data we have stored</p>
                                            </div>
                                            <form method="POST" action="{% url 'download_data' %}">
                                                {% csrf_token %}
                                                <button type="submit" class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg transition text-sm">
                                                    Request Data
                                                </button>
                                            </form>
                                        </div>
                                        
                                        <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                            <div>
                                                <p class="font-medium">Clear Search History</p>
                                                <p class="text-sm text-gray-600">Delete all your saved searches and browsing history</p>
                                            </div>
                                            <form method="POST" action="{% url 'clear_history' %}">
                                                {% csrf_token %}
                                                <button type="submit" class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg transition text-sm">
                                                    Clear History
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-6">
                                    <h3 class="text-lg font-bold text-blue-900 mb-4">Privacy Policy</h3>
                                    <p class="text-gray-700 mb-4">
                                        We value your privacy and are committed to protecting your personal information. 
                                        Our privacy policy explains how we collect, use, and safeguard your data.
                                    </p>
                                    <a href="{% url 'privacy' %}" class="text-blue-900 hover:text-blue-700 font-medium">View Full Privacy Policy</a>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Delete Account Section -->
                        <div id="delete" class="settings-section hidden">
                            <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-red-500">
                                <h2 class="text-2xl font-bold text-red-700 mb-6">Delete Account</h2>
                                
                                <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                                    <div class="flex">
                                        <i class="fas fa-exclamation-triangle text-red-500 text-xl mr-3 mt-1"></i>
                                        <div>
                                            <h3 class="font-bold text-red-700 mb-1">Warning: This action cannot be undone</h3>
                                            <p class="text-red-700">
                                                Deleting your account will permanently remove all your data, including saved properties, 
                                                search history, and consultation bookings. You will lose access to your account immediately.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-6">
                                    <h3 class="text-lg font-bold text-gray-800 mb-4">Before you proceed</h3>
                                    <ul class="list-disc list-inside text-gray-700 space-y-2 ml-4">
                                        <li>Download any data you wish to keep</li>
                                        <li>Cancel any upcoming consultations</li>
                                        <li>Ensure you have no pending transactions</li>
                                        <li>Consider deactivating your account instead</li>
                                    </ul>
                                </div>
                                
                                <div class="flex flex-col sm:flex-row gap-4">
                                    <form method="POST" action="{% url 'deactivate_account' %}" class="flex-1">
                                        {% csrf_token %}
                                        <button type="submit" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-lg transition">
                                            Deactivate Account Temporarily
                                        </button>
                                    </form>
                                    <button id="delete-account-btn" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition">
                                        Permanently Delete Account
                                    </button>
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            </div>
        </div>
    </section>

    <!-- Delete Account Modal -->
    <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
            <form method="POST" action="{% url 'delete_account' %}">
                {% csrf_token %}
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                    <h3 class="text-xl font-bold text-gray-900 mb-2">Delete Your Account?</h3>
                    <p class="text-gray-700 mb-6">
                        This action cannot be undone. All your data will be permanently deleted.
                    </p>
                    
                    <div class="mb-6">
                        <label class="block text-gray-700 font-medium mb-2">Enter your password to confirm</label>
                        <input type="password" name="password" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-900 focus:border-transparent"
                               placeholder="Enter your password" required>
                        {% if delete_form.password.errors %}
                            <p class="text-red-600 text-sm mt-1">{{ delete_form.password.errors }}</p>
                        {% endif %}
                    </div>
                    
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button type="button" id="cancel-delete" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-lg transition flex-1">
                            Cancel
                        </button>
                        <button type="submit" id="confirm-delete" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition flex-1">
                            Delete Account
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Custom Styles -->
    <style>
        .nav-item {
            @apply flex items-center px-4 py-3 text-gray-700 rounded-lg transition-colors cursor-pointer;
        }
        .nav-item:hover {
            @apply bg-blue-50 text-blue-900;
        }
        .nav-item.active {
            @apply bg-blue-900 text-white;
        }
        .settings-section {
            @apply transition-opacity duration-300;
        }
        .settings-section.active {
            @apply opacity-100 block;
        }
        .settings-section.hidden {
            @apply opacity-0 hidden;
        }
        .password-strength-bar {
            transition: all 0.3s ease;
        }
        .password-weak {
            @apply bg-red-500;
            width: 33%;
        }
        .password-medium {
            @apply bg-yellow-500;
            width: 66%;
        }
        .password-strong {
            @apply bg-green-500;
            width: 100%;
        }
    </style>

    <!-- Custom JavaScript -->
    <script>
        // Initialize AOS
        if (typeof AOS !== 'undefined') {
            AOS.init({
                duration: 1000,
                once: true,
                offset: 100
            });
        }

        // Settings Navigation
        document.addEventListener('DOMContentLoaded', function() {
            const navItems = document.querySelectorAll('.nav-item');
            const sections = document.querySelectorAll('.settings-section');

            navItems.forEach(item => {
                item.addEventListener('click', function() {
                    // Remove active class from all nav items
                    navItems.forEach(nav => nav.classList.remove('active'));
                    // Add active class to clicked item
                    this.classList.add('active');

                    // Hide all sections
                    sections.forEach(section => {
                        section.classList.add('hidden');
                        section.classList.remove('active');
                    });

                    // Show selected section
                    const sectionId = this.getAttribute('data-section');
                    const targetSection = document.getElementById(sectionId);
                    if (targetSection) {
                        targetSection.classList.remove('hidden');
                        targetSection.classList.add('active');
                    }
                });
            });

            // Password Strength Indicator
            const passwordInput = document.querySelector('input[name="new_password1"]');
            const passwordStrength = document.getElementById('password-strength');
            const passwordStrengthBar = document.querySelector('.password-strength-bar');

            if (passwordInput && passwordStrength && passwordStrengthBar) {
                passwordInput.addEventListener('input', function() {
                    const password = this.value;
                    let strength = 0;

                    // Check password length
                    if (password.length >= 8) strength++;
                    // Check for uppercase letters
                    if (/[A-Z]/.test(password)) strength++;
                    // Check for lowercase letters
                    if (/[a-z]/.test(password)) strength++;
                    // Check for numbers
                    if (/[0-9]/.test(password)) strength++;
                    // Check for special characters
                    if (/[^A-Za-z0-9]/.test(password)) strength++;

                    // Update strength indicator
                    passwordStrength.classList.remove('hidden');
                    passwordStrengthBar.className = 'h-full rounded password-strength-bar';

                    if (strength <= 2) {
                        passwordStrengthBar.classList.add('password-weak');
                    } else if (strength <= 4) {
                        passwordStrengthBar.classList.add('password-medium');
                    } else {
                        passwordStrengthBar.classList.add('password-strong');
                    }

                    // Hide if empty
                    if (password.length === 0) {
                        passwordStrength.classList.add('hidden');
                    }
                });
            }

            // Delete Account Modal
            const deleteAccountBtn = document.getElementById('delete-account-btn');
            const deleteModal = document.getElementById('delete-modal');
            const cancelDeleteBtn = document.getElementById('cancel-delete');

            if (deleteAccountBtn && deleteModal) {
                deleteAccountBtn.addEventListener('click', function() {
                    deleteModal.classList.remove('hidden');
                });
            }

            if (cancelDeleteBtn && deleteModal) {
                cancelDeleteBtn.addEventListener('click', function() {
                    deleteModal.classList.add('hidden');
                });
            }

            if (deleteModal) {
                deleteModal.addEventListener('click', function(e) {
                    if (e.target === deleteModal) {
                        deleteModal.classList.add('hidden');
                    }
                });
            }

            // Form submission handling
            document.querySelectorAll('form').forEach(form => {
                form.addEventListener('submit', function(e) {
                    const submitBtn = this.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        const originalText = submitBtn.textContent;
                        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>' + originalText;

                        // Re-enable after 3 seconds in case of error
                        setTimeout(() => {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalText;
                        }, 3000);
                    }
                });
            });

            // Handle checkbox arrays for locations and property types
            document.querySelectorAll('form').forEach(form => {
                form.addEventListener('submit', function(e) {
                    // Handle preferred_locations checkboxes
                    const locationCheckboxes = this.querySelectorAll('input[name="preferred_locations"]:checked');
                    const locationInput = document.createElement('input');
                    locationInput.type = 'hidden';
                    locationInput.name = 'preferred_locations';
                    locationInput.value = Array.from(locationCheckboxes).map(cb => cb.value).join(',');
                    this.appendChild(locationInput);

                    // Handle property_types checkboxes
                    const typeCheckboxes = this.querySelectorAll('input[name="property_types"]:checked');
                    const typeInput = document.createElement('input');
                    typeInput.type = 'hidden';
                    typeInput.name = 'property_types';
                    typeInput.value = Array.from(typeCheckboxes).map(cb => cb.value).join(',');
                    this.appendChild(typeInput);
                });
            });

            console.log('Settings page loaded successfully');
        });
    </script>
{% endblock %}