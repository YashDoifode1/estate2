{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}{{ property.title }} | DreamHomes Realty{% endblock %}

{% block content %}
    <!-- Breadcrumb -->
    <section class="bg-gray-100 py-4">
        <div class="container mx-auto px-4">
            <nav class="flex" aria-label="Breadcrumb">
                <ol class="flex items-center space-x-2 text-sm">
                    <li>
                        <a href="{% url 'home' %}" class="text-gray-500 hover:text-blue-900 transition">Home</a>
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                        <a href="{% url 'properties:property_list' %}" class="text-gray-500 hover:text-blue-900 transition">Properties</a>
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                        <span class="text-blue-900 font-medium">{{ property.title }}</span>
                    </li>
                </ol>
            </nav>
        </div>
    </section>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Property Details -->
            <div class="lg:w-2/3">
                <!-- Back to Listings Button -->
                <div class="mb-6">
                    <a href="{% url 'properties:property_list' %}" class="inline-flex items-center text-blue-900 hover:text-yellow-600 transition font-medium">
                        <i class="fas fa-arrow-left mr-2"></i> Back to Listings
                    </a>
                </div>
                
                <!-- Image Gallery -->
                <div class="mb-8">
                    {% if property.gallery_images %}
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {% for img in property.gallery_images %}
                                <div class="bg-gray-200 h-64 rounded-lg overflow-hidden flex items-center justify-center">
                                    <img src="{{ img.image.url }}" alt="{{ property.title }}" class="w-full h-full object-cover">
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <!-- Placeholder if no images -->
                        <div class="bg-gray-200 h-64 rounded-lg flex items-center justify-center">
                            <div class="text-center">
                                <i class="fas fa-home text-6xl text-blue-900 mb-4"></i>
                                <p class="text-gray-700 text-xl">Property Images</p>
                                <p class="text-gray-500">Image gallery would be displayed here</p>
                            </div>
                        </div>
                    {% endif %}
                </div>

                <!-- Property Title & Price -->
                <div class="mb-8">
                    <div class="flex flex-col md:flex-row md:justify-between md:items-start">
                        <div>
                            <span class="inline-block {% if property.status == 'for_sale' %}bg-yellow-600{% else %}bg-green-600{% endif %} text-white px-3 py-1 rounded-full text-sm font-semibold mb-2">
                                {% if property.status == 'for_sale' %}For Sale{% else %}For Rent{% endif %}
                            </span>
                            <h1 class="text-3xl font-bold text-blue-900 mb-2">{{ property.title }}</h1>
                            <p class="text-gray-600 flex items-center">
                                <i class="fas fa-map-marker-alt text-yellow-600 mr-2"></i> {{ property.location }}
                            </p>
                            <br>
                            <!-- Save Property Button -->
                            <form id="save-property-form" method="POST" action="{% url 'properties:toggle_save' property.id %}">
                                {% csrf_token %}
                                <button type="submit" id="save-btn"
                                    class="flex items-center gap-2 px-5 py-2.5 rounded-full font-semibold transition-all duration-300 shadow-md 
                                           {% if is_saved %}bg-yellow-600 hover:bg-yellow-700 text-white{% else %}bg-blue-900 hover:bg-blue-800 text-white{% endif %}">
                                    {% if is_saved %}
                                        <i class="fas fa-heart text-red-500 transition-transform duration-300 scale-110"></i> Saved
                                    {% else %}
                                        <i class="far fa-heart text-white transition-transform duration-300 hover:scale-110"></i> Save
                                    {% endif %}
                                </button>
                            </form>
                        </div>
                        <div class="mt-4 md:mt-0">
                            <p class="text-3xl font-bold text-blue-900">
                                ₹{{ property.price|floatformat:0 }}{% if property.status == 'for_rent' %}/month{% endif %}
                            </p>
                            {% if property.price_per_sqft %}
                                <p class="text-gray-600 text-right">₹{{ property.price_per_sqft|floatformat:0 }}/sq.ft.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Property Highlights -->
                <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                    <h2 class="text-xl font-bold text-blue-900 mb-4">Property Highlights</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center">
                            <div class="bg-blue-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-2">
                                <i class="fas fa-bed text-blue-900 text-xl"></i>
                            </div>
                            <p class="font-semibold">{{ property.bedrooms }} Bedroom{{ property.bedrooms|pluralize }}</p>
                        </div>
                        <div class="text-center">
                            <div class="bg-blue-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-2">
                                <i class="fas fa-bath text-blue-900 text-xl"></i>
                            </div>
                            <p class="font-semibold">{{ property.bathrooms }} Bathroom{{ property.bathrooms|pluralize }}</p>
                        </div>
                        <div class="text-center">
                            <div class="bg-blue-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-2">
                                <i class="fas fa-vector-square text-blue-900 text-xl"></i>
                            </div>
                            <p class="font-semibold">{{ property.total_area }} sq.ft.</p>
                        </div>
                        <div class="text-center">
                            <div class="bg-blue-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-2">
                                <i class="fas fa-building text-blue-900 text-xl"></i>
                            </div>
                            <p class="font-semibold">{{ property.get_type_display }}</p>
                        </div>
                    </div>
                </div>
                
                <!-- Property Description -->
                <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                    <h2 class="text-xl font-bold text-blue-900 mb-4">Property Description</h2>
                    <div class="text-gray-700 whitespace-pre-line">{{ property.description }}</div>
                </div>
                
                <!-- Amenities -->
                <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                    <h2 class="text-xl font-bold text-blue-900 mb-4">Amenities</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {% if property.amenities.all %}
                            {% for property_amenity in property.amenities.all %}
                                <div class="flex items-center">
                                    <i class="{{ property_amenity.amenity.icon_class }} text-yellow-600 mr-3"></i>
                                    <span>{{ property_amenity.amenity.name }}</span>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-gray-600">No amenities listed.</p>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Property Details -->
                <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                    <h2 class="text-xl font-bold text-blue-900 mb-4">Property Details</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex justify-between py-2 border-b border-gray-200">
                            <span class="text-gray-600">Property ID</span>
                            <span class="font-semibold">{{ property.property_id }}</span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-gray-200">
                            <span class="text-gray-600">Property Type</span>
                            <span class="font-semibold">{{ property.get_type_display }}</span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-gray-200">
                            <span class="text-gray-600">Property Status</span>
                            <span class="font-semibold">{{ property.get_status_display }}</span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-gray-200">
                            <span class="text-gray-600">Year Built</span>
                            <span class="font-semibold">{{ property.year_built }}</span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-gray-200">
                            <span class="text-gray-600">Total Area</span>
                            <span class="font-semibold">{{ property.total_area }} sq.ft.</span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-gray-200">
                            <span class="text-gray-600">Bedrooms</span>
                            <span class="font-semibold">{{ property.bedrooms }}</span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-gray-200">
                            <span class="text-gray-600">Bathrooms</span>
                            <span class="font-semibold">{{ property.bathrooms }}</span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-gray-200">
                            <span class="text-gray-600">Garage</span>
                            <span class="font-semibold">{{ property.garage }} car{{ property.garage|pluralize }}</span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-gray-200">
                            <span class="text-gray-600">Floor</span>
                            <span class="font-semibold">{{ property.floor_number }}/{{ property.floors }}</span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-gray-200">
                            <span class="text-gray-600">Furnishing</span>
                            <span class="font-semibold">{{ property.get_furnishing_display }}</span>
                        </div>
                        <!-- Latitude and Longitude Details -->
                        {% if property.latitude and property.longitude %}
                        <div class="flex justify-between py-2 border-b border-gray-200">
                            <span class="text-gray-600">Latitude</span>
                            <span class="font-semibold">{{ property.latitude }}</span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-gray-200">
                            <span class="text-gray-600">Longitude</span>
                            <span class="font-semibold">{{ property.longitude }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Location & Map -->
                <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                    <h2 class="text-xl font-bold text-blue-900 mb-4">Location</h2>
                    <p class="text-gray-700 mb-4">{{ property.location_description|default:"Prime location with excellent connectivity and amenities." }}</p>
                    
                    <!-- Interactive Map -->
                    <div id="property-map" class="h-64 rounded-lg mb-6 border border-gray-300"></div>
                    
                    <!-- Address Details -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-lg font-semibold text-blue-900 mb-3">Address Information</h3>
                            <div class="space-y-2">
                                <div class="flex items-center">
                                    <i class="fas fa-map-marker-alt text-yellow-600 w-5 mr-3"></i>
                                    <span class="text-gray-700">{{ property.location }}</span>
                                </div>
                                <div class="flex items-center">
                                    <i class="fas fa-city text-yellow-600 w-5 mr-3"></i>
                                    <span class="text-gray-700">{{ property.city }}</span>
                                </div>
                                <div class="flex items-center">
                                    <i class="fas fa-flag text-yellow-600 w-5 mr-3"></i>
                                    <span class="text-gray-700">{{ property.state }}</span>
                                </div>
                                <div class="flex items-center">
                                    <i class="fas fa-mail-bulk text-yellow-600 w-5 mr-3"></i>
                                    <span class="text-gray-700">{{ property.pincode }}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h3 class="text-lg font-semibold text-blue-900 mb-3">Location Details</h3>
                            <div class="space-y-2">
                                {% if property.latitude and property.longitude %}
                                <div class="flex items-center">
                                    <i class="fas fa-globe-americas text-yellow-600 w-5 mr-3"></i>
                                    <div>
                                        <span class="text-gray-700 block">Coordinates</span>
                                        <span class="text-sm text-gray-500">{{ property.latitude }}, {{ property.longitude }}</span>
                                    </div>
                                </div>
                                {% endif %}
                                <div class="flex items-center">
                                    <i class="fas fa-road text-yellow-600 w-5 mr-3"></i>
                                    <span class="text-gray-700">Easy Access to Main Roads</span>
                                </div>
                                <div class="flex items-center">
                                    <i class="fas fa-subway text-yellow-600 w-5 mr-3"></i>
                                    <span class="text-gray-700">Public Transport Nearby</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Nearby Places -->
                <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                    <h2 class="text-xl font-bold text-blue-900 mb-4">Nearby Places</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {% if property.nearby_places.all %}
                            {% for place in property.nearby_places.all %}
                                <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                                    <i class="{{ place.icon_class }} text-yellow-600 text-xl w-8 mr-3"></i>
                                    <div>
                                        <p class="font-medium text-gray-800">{{ place.name }}</p>
                                        <p class="text-gray-600 text-sm">{{ place.distance }} away</p>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-gray-600 col-span-2">No nearby places listed.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Sidebar -->
            <div class="lg:w-1/3">
                <div class="sticky top-24">
                    <!-- Contact Form -->
                    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                        <h2 class="text-xl font-bold text-blue-900 mb-4">Schedule a Visit</h2>
                        <p class="text-gray-600 mb-4">Interested in this property? Fill out the form below and our agent will contact you shortly.</p>
                        
                        <form class="contact-form" id="schedule-visit-form" method="POST" action="{% url 'properties:schedule_visit' property.id %}">
                            {% csrf_token %}
                            <div class="mb-4">
                                <input type="text" name="name" placeholder="Your Name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-900" required>
                            </div>
                            <div class="mb-4">
                                <input type="email" name="email" placeholder="Your Email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-900" required>
                            </div>
                            <div class="mb-4">
                                <input type="tel" name="phone" placeholder="Your Phone Number" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-900" required>
                            </div>
                            <div class="mb-4">
                                <input type="date" name="preferred_date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-900" required>
                            </div>
                            <div class="mb-4">
                                <input type="time" name="preferred_time" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-900" required>
                            </div>
                            <div class="mb-4">
                                <textarea name="message" placeholder="Any specific requirements or questions..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-900" rows="4"></textarea>
                            </div>
                            <button type="submit" class="w-full bg-blue-900 hover:bg-blue-800 text-white font-bold py-3 rounded-lg transition">
                                Schedule Visit
                            </button>
                        </form>
                    </div>
                    
                    <!-- Contact Agent -->
                    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                        <h2 class="text-xl font-bold text-blue-900 mb-4">Contact Agent</h2>
                        <div class="flex items-center mb-4">
                            <img src="{{ property.agent.image_url|default:'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?ixlib=rb-1.2.1&auto=format&fit=facearea&facepad=2&w=256&h=256&q=80' }}" 
                                 alt="{{ property.agent.name }}" class="w-16 h-16 rounded-full mr-4 object-cover">
                            <div>
                                <h3 class="font-bold text-blue-900">{{ property.agent.name }}</h3>
                                <p class="text-gray-600">{{ property.agent.title }}</p>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <div class="flex items-center">
                                <i class="fas fa-phone text-yellow-600 mr-3"></i>
                                <span>{{ property.agent.phone }}</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-envelope text-yellow-600 mr-3"></i>
                                <span>{{ property.agent.email }}</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-briefcase text-yellow-600 mr-3"></i>
                                <span>{{ property.agent.experience }}+ years experience</span>
                            </div>
                        </div>
                        <a href="{% url 'agents:contact_agent' property.agent.id %}" class="w-full mt-4 block bg-transparent border-2 border-blue-900 text-blue-900 hover:bg-blue-900 hover:text-white font-bold py-2 rounded-lg transition text-center">
                            <i class="fas fa-comment-dots mr-2"></i> Contact Agent
                        </a>
                    </div>
                    
                    <!-- Similar Properties -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-bold text-blue-900 mb-4">Similar Properties</h2>
                        <div class="space-y-4">
                            {% for similar_property in similar_properties %}
                                <div class="flex border rounded-lg overflow-hidden">
                                    <div class="bg-gray-200 w-24 h-24 flex items-center justify-center">
                                        <i class="fas fa-home text-blue-900 text-2xl"></i>
                                    </div>
                                    <div class="p-3 flex-1">
                                        <h3 class="font-bold text-blue-900 text-sm">{{ similar_property.title }}</h3>
                                        <p class="text-gray-600 text-sm mb-1">₹{{ similar_property.price|floatformat:0 }}{% if similar_property.status == 'for_rent' %}/month{% endif %}</p>
                                        <a href="{% url 'properties:property_detail' similar_property.id %}" 
                                           class="text-blue-900 text-sm font-medium hover:text-yellow-600 transition">View Details</a>
                                    </div>
                                </div>
                            {% empty %}
                                <p class="text-gray-600">No similar properties found.</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- CTA Section -->
    <section class="py-16 bg-blue-900 text-white mt-12">
        <div class="container mx-auto px-4 text-center">
            <h2 class="text-3xl md:text-4xl font-bold mb-6">Interested in This Property?</h2>
            <p class="text-xl mb-10 max-w-2xl mx-auto">
                Contact our agent today to schedule a viewing or get more information.
            </p>
            <div class="flex flex-col md:flex-row justify-center space-y-4 md:space-y-0 md:space-x-4">
                <a href="tel:{{ property.agent.phone }}" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-8 rounded-lg transition">
                    <i class="fas fa-phone mr-2"></i> Call Now
                </a>
                <a href="mailto:{{ property.agent.email }}" class="bg-transparent border-2 border-white hover:bg-white hover:text-blue-900 text-white font-bold py-3 px-8 rounded-lg transition">
                    <i class="fas fa-envelope mr-2"></i> Email Agent
                </a>
            </div>
        </div>
    </section>

    <!-- OpenStreetMap CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- Custom JavaScript -->
    <script>
        // --- Schedule Visit Form ---
        document.getElementById('schedule-visit-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);

            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    this.reset();
                } else {
                    alert('Error submitting form. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error submitting form. Please try again.');
            });
        });

        // --- Save Property Feature ---
        const saveForm = document.getElementById('save-property-form');
        if (saveForm) {
            saveForm.addEventListener('submit', function(e) {
                e.preventDefault();

                const form = this;
                const button = form.querySelector('button');
                const icon = button.querySelector('i');

                fetch(form.action, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (data.is_saved) {
                            button.classList.remove('bg-blue-900', 'hover:bg-blue-800');
                            button.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
                            icon.classList.remove('far', 'text-white');
                            icon.classList.add('fas', 'text-red-500');
                            icon.style.transform = 'scale(1.3)';
                            button.innerHTML = '<i class="fas fa-heart text-red-500 mr-2"></i> Saved';
                            setTimeout(() => icon.style.transform = 'scale(1)', 200);
                        } else {
                            button.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
                            button.classList.add('bg-blue-900', 'hover:bg-blue-800');
                            icon.classList.remove('fas', 'text-red-500');
                            icon.classList.add('far', 'text-white');
                            icon.style.transform = 'scale(1)';
                            button.innerHTML = '<i class="far fa-heart text-white mr-2"></i> Save';
                        }

                        showToast(data.message);
                    } else {
                        showToast('Something went wrong. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Error saving property.');
                });
            });
        }

        // --- OpenStreetMap Integration ---
        document.addEventListener('DOMContentLoaded', function () {
            const mapElement = document.getElementById('property-map');
            if (mapElement) {
                const defaultLat = {{ property.latitude|default:"21.1458" }};
                const defaultLng = {{ property.longitude|default:"79.0882" }};
                
                const map = L.map('property-map').setView([defaultLat, defaultLng], 15);

                // OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 19
                }).addTo(map);

                // Marker
                L.marker([defaultLat, defaultLng])
                    .addTo(map)
                    .bindPopup(`
                        <div class="p-2">
                            <h4 class="font-bold text-blue-900">{{ property.title }}</h4>
                            <p class="text-sm text-gray-600">{{ property.location }}</p>
                            <p class="text-sm font-semibold text-green-600">₹{{ property.price|floatformat:0 }}</p>
                        </div>
                    `)
                    .openPopup();
            }
        });

        // Simple Toast Notification
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-5 right-5 bg-blue-900 text-white px-5 py-3 rounded-lg shadow-lg text-sm z-50 animate-fadeIn';
            toast.innerText = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2500);
        }
    </script>

    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        
        /* Leaflet Map Styles */
        #property-map { 
            z-index: 1;
        }
    </style>
{% endblock %}